<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RNA-Seq Power Calculator – DESeq2 Extended</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; padding: 20px; }
    input, select, button {
      margin: 5px; padding: 5px; border-radius: 4px;
      background-color: #222; color: #fff; border: 1px solid #555;
    }
    .output { margin-top: 20px; font-weight: bold; }
    .legend-box, .var-desc { margin-top: 30px; padding: 1em; background: #1b1b1b; border: 1px solid #333; }
    pre { white-space: pre-wrap; color: #90caf9; }
  </style>
</head>
<body>
<h2>RNA-Seq Power Calculator – DESeq2 Extended</h2><label>CPM: <input type="number" id="cpm" value="10"></label> <label>Library size (millions): <input type="number" id="libsize" value="20"></label> <button onclick="convertCPM()">Convert CPM → Mean expression (μ)</button><br>

<label>Mean expression (μ): <input type="number" id="mu" value="100"></label><br> <label>Dispersion (α): <input type="number" id="dispersion" value="0.1" step="0.01"></label><br> <label>log2 fold change (Δ): <input type="number" id="lfc" value="1" step="0.1"></label><br> <label>Replicates per group: <input type="number" id="n" value="3" min="3"></label><br> <label>Significance level (α): <input type="number" id="alpha" value="0.05" step="0.01"></label><br>

<button onclick="calculatePower()">Calculate Power</button>

<div class="output" id="result"></div>
<div id="muplot" style="margin-top:30px;"></div>
<div id="dispplot"></div>
<div id="nplot"></div><div class="var-desc">
  <h3>Explanation of Parameters</h3>
  <ul>
    <li><strong>μ (mu):</strong> Mean count for an isoform/gene.</li>
    <li><strong>CPM:</strong> Counts per million reads (expression unit).</li>
    <li><strong>Library size:</strong> Number of total reads in millions (e.g. 20M).</li>
    <li><strong>Dispersion (α):</strong> Biological variation parameter.</li>
    <li><strong>log2 fold change:</strong> Effect size between two conditions.</li>
    <li><strong>n:</strong> Number of replicates per group.</li>
    <li><strong>α (significance):</strong> Type I error threshold (e.g. 0.05).</li>
  </ul>
</div><script>
function normCdf(z) {
  return 0.5 * (1 + erf(z / Math.sqrt(2)));
}
function erf(x) {
  const sign = x >= 0 ? 1 : -1;
  x = Math.abs(x);
  const t = 1 / (1 + 0.5 * x);
  const y = 1 - t * Math.exp(-x*x - 1.26551223 +
    t * (1.00002368 + t * (0.37409196 + t * (0.09678418 +
    t * (-0.18628806 + t * (0.27886807 + t * (-1.13520398 +
    t * (1.48851587 + t * (-0.82215223 + t * 0.17087277)))))))));
  return sign * y;
}
function inverseErf(x) {
  const a = 0.147;
  const ln = Math.log(1 - x * x);
  const term1 = (2 / (Math.PI * a)) + (ln / 2);
  const term2 = ln / a;
  return Math.sign(x) * Math.sqrt(Math.sqrt(term1 * term1 - term2) - term1);
}
function convertCPM() {
  const cpm = parseFloat(document.getElementById("cpm").value);
  const lib = parseFloat(document.getElementById("libsize").value);
  const mu = cpm * lib / 1e6 * 1e6; // back to raw count
  document.getElementById("mu").value = mu.toFixed(0);
}
function calculatePower() {
  const mu = parseFloat(document.getElementById("mu").value);
  const alpha = parseFloat(document.getElementById("dispersion").value);
  const lfc = parseFloat(document.getElementById("lfc").value);
  const n = parseInt(document.getElementById("n").value);
  const alphaTest = parseFloat(document.getElementById("alpha").value);

  const var_nb = mu + alpha * mu * mu;
  const se = Math.sqrt((2 / n) * var_nb / (mu * mu));
  const z = Math.abs(lfc) / se;
  const z_crit = inverseErf(1 - alphaTest) * Math.sqrt(2);
  const power = 1 - normCdf(z_crit - z);

  document.getElementById("result").innerText = `Estimated power: ${(power * 100).toFixed(1)}%`;
  drawSensitivity(mu, alpha, lfc, alphaTest);
}
function drawSensitivity(mu, alpha, lfc, alphaTest) {
  const z_crit = inverseErf(1 - alphaTest) * Math.sqrt(2);

  // μ plot
  const muvals = [], p_mu = [];
  for (let m = 5; m <= 500; m += 10) {
    const v = m + alpha * m * m;
    const se = Math.sqrt((2/3) * v / (m * m));
    const z = Math.abs(lfc) / se;
    p_mu.push(1 - normCdf(z_crit - z));
    muvals.push(m);
  }
  Plotly.newPlot("muplot", [{x: muvals, y: p_mu, type: 'scatter'}], {
    title: 'Power vs Mean Expression (μ)',
    xaxis: { title: 'μ' }, yaxis: { title: 'Power', range: [0, 1] },
    paper_bgcolor: '#111', plot_bgcolor: '#111', font: { color: '#eee' }
  });

  // Dispersion plot
  const dvals = [], p_d = [];
  for (let d = 0.01; d <= 0.3; d += 0.01) {
    const v = mu + d * mu * mu;
    const se = Math.sqrt((2/3) * v / (mu * mu));
    const z = Math.abs(lfc) / se;
    p_d.push(1 - normCdf(z_crit - z));
    dvals.push(d);
  }
  Plotly.newPlot("dispplot", [{x: dvals, y: p_d, type: 'scatter'}], {
    title: 'Power vs Dispersion (α)',
    xaxis: { title: 'Dispersion (α)' }, yaxis: { title: 'Power', range: [0, 1] },
    paper_bgcolor: '#111', plot_bgcolor: '#111', font: { color: '#eee' }
  });

  // n plot
  const nvals = [], p_n = [];
  for (let rep = 2; rep <= 30; rep++) {
    const v = mu + alpha * mu * mu;
    const se = Math.sqrt((2 / rep) * v / (mu * mu));
    const z = Math.abs(lfc) / se;
    p_n.push(1 - normCdf(z_crit - z));
    nvals.push(rep);
  }
  Plotly.newPlot("nplot", [{x: nvals, y: p_n, type: 'scatter'}], {
    title: 'Power vs Replicates (n)',
    xaxis: { title: 'Replicates per group (n)' }, yaxis: { title: 'Power', range: [0, 1] },
    paper_bgcolor: '#111', plot_bgcolor: '#111', font: { color: '#eee' }
  });
}
</script></body>
</html>